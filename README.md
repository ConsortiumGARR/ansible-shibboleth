# ANSIBLE CODE TO INSTALL SHIBBOLETH PRODUCTS

## Simple flow to install and configure a Shibboleth IdP

1. ```cd /opt/```

2. ```git clone https://github.com/malavolti/ansible-shibboleth.git```

3. Edit the ```[production|test|developmet].ini``` inventory by adding your virtual machine servers.

4. Create your ```.vault_pass.txt``` that contains the encryption password.

5. Create your own ```/opt/ansible-shibboleth/hosts_vars/##FULL.VM.QUALIFIED.DOMAIN.NAME##.yml```:
    ```yaml
    # file: host_vars/##FULL.VM.QUALIFIED.DOMAIN.NAME##.yml
    https_domain: "example.org"
    
    # LDAP Variables
    ldap_basedn: "dc=example,dc=org"
    ldap_domain: "example.org"
    ldap_org: "EXAMPLE Institution"
    ldap_host: "{{ ansible_hostname }}.{{ https_domain }}"
    ldap_user: "openldap"
    ldap_root_pw: "##ONE_PASSWORD##"

    # IDP Variables
    restore: "False"

    idp_pw: "##IDP_PASSWORD##"

    idp_sealer_pw: "## IDP SEALER PASSWORD ##"
    idp_keystore_pw: "## IDP BACKCHANNEL PASSWORD"

    root_db_password: "## ROOT DB PASSWORD ##"
    shibboleth_db_password: "## SHIBBOLETH USER DB PASSWORD"

    ## IDP BASIC CONFIGURATION VARIABLE ##

    ### idp_sourceAttribute: 
    ### MUST BE an attribute, or a list of comma-separated attributes, 
    ### that uniquely identify the subject of the generated persistent-id.
    ### It MUST BE: Stable, Permanent and Not-reassignable
    idp_sourceAttribute: "uid"

    ### idp_persistent_salt: 
    ### generated by 'openssl rand -base64 36'
    idp_persistentId_salt: "OS0wCcdZADpiIR2VqyNKOW62YOPQNYRPDzN1u5uuW-qUkynS"

    ### Federation Metadata URL
    metadata_providers:
     - id: "IDEM-TEST-FEDERATION"
       file: "idem-test-metadata-sha256.xml"
       url: "http://www.garr.it/idem-metadata/idem-test-metadata-sha256.xml"
       pubKey: |
        MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAxrLc3bV+zC7cATqGoI9R
        WO8LKiXk4pMez0JcMgXICiKA/5hJ2WgtIbDHqfqSz1oFsmqXNEEgR3cKkHK9fsaY
        G4hOXcSWHExjjQK/9QuiTUZsOZAyE9JxTonV/1vnbpH0qz4FthliYFFf2CqalfVH
        zrsgRLjP4mFedevkrwdM+N9oMaHbE5EvqaxePDAMmBokI6kEJy0u8JZyZSnS5ymX
        xUcaMUAAjkRvqnBAQQ+PXKpbnaCAz4Ac0VjpsAL1FftC/wyidBnBek00E0v5RycY
        tUFe0F+13jOrtfE8030X8SV7dgkZo5WTxwIQm3lJ9N6C7NRoDKHx/8F8SzoLC5wJ
        KwIDAQAB
     - id: "IDEM-PRODUCTION-FEDERATION"
       file: "idem-metadata-sha256.xml"
       url: "http://www.garr.it/idem-metadata/idem-metadata-sha256.xml"
       pubKey: |
        MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAxrLc3bV+zC7cATqGoI9R
        WO8LKiXk4pMez0JcMgXICiKA/5hJ2WgtIbDHqfqSz1oFsmqXNEEgR3cKkHK9fsaY
        G4hOXcSWHExjjQK/9QuiTUZsOZAyE9JxTonV/1vnbpH0qz4FthliYFFf2CqalfVH
        zrsgRLjP4mFedevkrwdM+N9oMaHbE5EvqaxePDAMmBokI6kEJy0u8JZyZSnS5ymX
        xUcaMUAAjkRvqnBAQQ+PXKpbnaCAz4Ac0VjpsAL1FftC/wyidBnBek00E0v5RycY
        tUFe0F+13jOrtfE8030X8SV7dgkZo5WTxwIQm3lJ9N6C7NRoDKHx/8F8SzoLC5wJ
        KwIDAQAB
    ```
6. Ecrypted with your Ansible Vault:
    * ```cd /opt/ansible-shibboleth```
    * ```ansible-vault encrypt host_vars/##FULL.VM.QUALIFIED.DOMAIN.NAME##.yml --vault-password-file .vault_pass.txt```

7. Insert your "```hostname.domain.name.ext.crt```", "```hostname.domain.name.ext.key```" and "```CA.crt```" inside ```/opt/ansible-shibboleth/roles/common/files```.

8. Run this command to run Ansible on develoment inventory to install and configure an IdP (under development) only on development VMs:
    ```ansible-playbook shib-idp.yml -i development.ini --limit ##FULL.VM.QUALIFIED.DOMAIN.NAME## --vault-password-file .vault_pass.txt```

## Documentation ##
The environment (production,development, test, ...) are located into different files:
   - ```development.ini```
   - ```production.ini```
   - ```test.ini```
   - ...

Each environment file divides the architectures through different labels:
   - ```[Debian]```
   - ```[RedHat]```
   - ...

The "```site.yml```" file contains what will be installed on the machine provided by the environment:
   - ```shib-idp.yml``` (Install,Configure and Run a Shibboleth IdP)
   - ...

The "```shib-idp.yml```" contains:
   - ```hosts``` (who will receive the sync)
   - ```remote_user``` (who will access via SSH on the VMs)
   - ```roles``` (what will be installed and configured on the VMs)

The "```group_vars/```" directory contains:
   - ```all.yml```      (will contains all shared variable between architectures)
   - ```Debian.yml```   (will contains all variable debian-oriented)
   - ```RedHat.yml```   (will contains all variable redhat-oriented)

"```host_vars```" directory contains one "full.qualified.domain.name.yml" for each VM that will contains some specific variables for the VM. 
(This files have to be encrypted if shared on GitHub or somewhere other)

## Useful Commands ##

```
--- development.ini ---
[Debian]
ansible-slave-1.example.garr.it
ansible-slave-2.test.garr.it
-----------------------
```

1. Test that the connection with the VMs is working:
   * ```ansible all -m ping -i /opt/ansible-shibboleth/development.ini -u debian```
   ("```debian```" is the user used to perform the SSH connection with the client to synchronize)

2. Get the facts from the VMs:
   * ```ansible GROUP_NAME_or_HOST_NAME -m setup -i /opt/ansible-shibboleth/development.ini -u debian```

   Examples:
      * without encrypted files:
         ```ansible GROUP_NAME_or_HOST_NAME -m setup -i /opt/ansible-shibboleth/development.ini -u debian```
      * with encrypted files:
         ```ansible GROUP_NAME_or_HOST_NAME -m setup -i /opt/ansible-shibboleth/development.ini -u debian --vault-password-file .vault_pass.txt```

   ("```.vault_pass.txt```" is the file you have created that contains the encryption password)

3. Encrypt files:
   * ```ansible-vault encrypt host_vars/#_full.qualified.domain.name_#.yml --vault-password-file .vault_pass.txt```

4. Decrypt Encrypted files:
   * ```ansible-vault decrypt host_vars/#_full.qualified.domain.name_#.yml --vault-password-file .vault_pass.txt```

5. View Encrypted files:
   * ```ansible-vault view host_vars/#_full.qualified.domain.name_#.yml --vault-password-file .vault_pass.txt```
