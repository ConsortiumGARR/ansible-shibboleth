# ANSIBLE CODE TO INSTALL SHIBBOLETH PRODUCTS

## Simple flow to install and configure a Shibboleth IdP

1. Move on the ```/opt``` directory and download the Ansible-Shibboleth code:
    * ```cd /opt/```
    * ```git clone https://github.com/malavolti/ansible-shibboleth.git ; cd /opt/ansible-shibboleth```

2. Edit the ```[production|test|developmet].ini``` inventory by adding your servers.

3. Create your ```.vault_pass.txt``` that contains the encryption password:
    * ```echo YOUR_VAULT_PASSWORD > /opt/ansible-shibboleth/.vault_pass.txt```

4. Create the IdP configuration file as ```/opt/ansible-shibboleth/hosts_vars/FQDN.yml```:
    ```yaml
    # file: host_vars/##FQDN##.yml
    https_domain: "example.org"
    
    # LDAP Variables
    ldap_basedn: "dc=example,dc=org"
    ldap_domain: "example.org"
    ldap_org: "EXAMPLE Institution"
    ldap_host: "{{ ansible_hostname }}.{{ https_domain }}"
    ldap_user: "openldap"
    ldap_root_pw: "##ONE_PASSWORD##"

    # MySQL Variables
    mysql_root_password: "## ROOT DB PASSWORD ##"

    # IDP Variables

    # Set to 'True' to perform an IdP Restoration
    idp_restore: "False"

    idp_pw: "## IDP PASSWORD ##"
    idp_sealer_pw: "## IDP SEALER PASSWORD ##"
    idp_keystore_pw: "## IDP BACKCHANNEL PASSWORD ##"

    idp_shibboleth_db_password: "## SHIBBOLETH USER DB PASSWORD ##"

    ## IDP BASIC CONFIGURATION VARIABLE ##

    ## IDP STYLE ##
    idp_footer_text_color: "#ffffff"
    idp_footer_background_color: "#717171"

    ### idp_sourceAttribute: 
    ### MUST BE an attribute, or a list of comma-separated attributes, 
    ### that uniquely identify the subject of the generated persistent-id.
    ### It MUST BE: Stable, Permanent and Not-reassignable
    idp_sourceAttribute: "uid"

    ### idp_persistent_salt: 
    ### generated by 'openssl rand -base64 36'
    idp_persistentId_salt: "OS0wCcdZADpiIR2VqyNKOW62YOPQNYRPDzN1u5uuW-qUkynS"

    ### IDP Metadata Variables ###
    
    idp_edugain_url_it: "http://www.geant.org/Services/Trust_identity_and_security/eduGAIN"
    idp_edugain_logo_it: "/images/edugain-logo.png"
    idp_edugain_name_it: "Interfederazione eduGAIN"

    idp_edugain_url_en: "http://www.geant.org/Services/Trust_identity_and_security/eduGAIN"
    idp_edugain_logo_en: "/images/edugain-logo.png"
    idp_edugain_name_en: "eduGAIN Interfederation"

    idp_federation_url_it: "http://www.federation-url.it/"
    idp_federation_url_en: "http://www.federation-url.it/en/"

    idp_federation_logo_it: "/images/federation-logo.png"
    idp_federation_logo_en: "/images/federation-logo.png"

    idp_federation_name_it: "FEDERATION NAME IT"
    idp_federation_name_en: "FEDERATION NAME ENG"

    idp_federation_regAuth: "http://registration.authority.com/"

    idp_metadata:
       it:
          mdui_displayName: "Organization english Display Name"
          mdui_description: "IDP di Test per Organization Name"
          mdui_infoUrl: "https://{{ ansible_hostname }}.{{ https_domain }}/it/info.html"
          mdui_privacyUrl: "https://{{ ansible_hostname }}.{{ https_domain }}/it/privacy.html"
          mdui_favicon: "https://{{ ansible_hostname }}.{{ https_domain }}/it/favicon.png"
          mdui_logo: "https://{{ ansible_hostname }}.{{ https_domain }}/it/logo.png"
          org_name: "Organization italian Name"
          org_displayName: "Organization italian Display Name "
          org_url: "http://www.orgUrl.it"
       en:
          mdui_displayName: "Organization english Display Name"
          mdui_description: "IDP di Test per Organization Name"
          mdui_infoUrl: "https://{{ ansible_hostname }}.{{ https_domain }}/en/info.html"
          mdui_privacyUrl: "https://{{ ansible_hostname }}.{{ https_domain }}/en/privacy.html"
          mdui_favicon: "https://{{ ansible_hostname }}.{{ https_domain }}/en/favicon.png"
          mdui_logo: "https://{{ ansible_hostname }}.{{ https_domain }}/en/logo.png"
          org_name: "Organization english Name"
          org_displayName: "Organization english Display Name"
          org_url: "http://www.orgUrl.uk/"
       
    idp_contacts:
       technical:
          givenName: "Name"
          surName: "Surname"
          mail: "email.address@example.it"
       support:
          givenName: "Name"
          surName: "Surname"
          mail: "email.address@example.it"

    ### Federation Metadata URL
    idp_metadata_providers:
     - id: "IDEM-TEST-FEDERATION"
       file: "idem-test-metadata-sha256.xml"
       url: "http://www.garr.it/idem-metadata/idem-test-metadata-sha256.xml"
       pubKey: |
        MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAxrLc3bV+zC7cATqGoI9R
        WO8LKiXk4pMez0JcMgXICiKA/5hJ2WgtIbDHqfqSz1oFsmqXNEEgR3cKkHK9fsaY
        G4hOXcSWHExjjQK/9QuiTUZsOZAyE9JxTonV/1vnbpH0qz4FthliYFFf2CqalfVH
        zrsgRLjP4mFedevkrwdM+N9oMaHbE5EvqaxePDAMmBokI6kEJy0u8JZyZSnS5ymX
        xUcaMUAAjkRvqnBAQQ+PXKpbnaCAz4Ac0VjpsAL1FftC/wyidBnBek00E0v5RycY
        tUFe0F+13jOrtfE8030X8SV7dgkZo5WTxwIQm3lJ9N6C7NRoDKHx/8F8SzoLC5wJ
        KwIDAQAB
     - id: "IDEM-PRODUCTION-FEDERATION"
       file: "idem-metadata-sha256.xml"
       url: "http://www.garr.it/idem-metadata/idem-metadata-sha256.xml"
       pubKey: |
        MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAxrLc3bV+zC7cATqGoI9R
        WO8LKiXk4pMez0JcMgXICiKA/5hJ2WgtIbDHqfqSz1oFsmqXNEEgR3cKkHK9fsaY
        G4hOXcSWHExjjQK/9QuiTUZsOZAyE9JxTonV/1vnbpH0qz4FthliYFFf2CqalfVH
        zrsgRLjP4mFedevkrwdM+N9oMaHbE5EvqaxePDAMmBokI6kEJy0u8JZyZSnS5ymX
        xUcaMUAAjkRvqnBAQQ+PXKpbnaCAz4Ac0VjpsAL1FftC/wyidBnBek00E0v5RycY
        tUFe0F+13jOrtfE8030X8SV7dgkZo5WTxwIQm3lJ9N6C7NRoDKHx/8F8SzoLC5wJ
        KwIDAQAB
    ```
5. Ecrypt the IdP configuration file with Ansible Vault:
    * ```cd /opt/ansible-shibboleth```
    * ```ansible-vault encrypt host_vars/FQDN.yml --vault-password-file .vault_pass.txt```

6. Insert the IdP's HTTPS Certificate renamed into "```hostname.domain.name.ext.crt```", the IdP's HTTPS Certificate Key renamed into "```hostname.domain.name.ext.key```" and the Certification Authority certificate renamed into "```CA.crt```" inside ```/opt/ansible-shibboleth/roles/common/files```.

7. If you need to restore your IdP credentials insert the entire "```/opt/shibboleth-idp/credentials```" directory in the "```roles/idp/files/restore/##hostname##/```" directory and set the ```idp_restore = "True"```.

8. Upload the IdP style's file (flag, favicon and logo) in the "```roles/idp/files/restore/##hostname##/styles```" by following the ```README.md``` file. A "hostname-sample" has been created to help you with this.

9. Add the IdP Information and Privacy Policy page templates in the "```roles/idp/templates/styles/```" in your language by copying the english '```en/```' sample and changing each "```idp_metadata['en']```" (inside the "```info.html.j2```" and "```privacy.html.j2```" pages) and be sure to adapt the text of the pages.

The ansible recipes use the languages provided by the "```idp_metadata```" dictionary so you **HAVE TO LEAVE** the default language "en" and add all other languages that your IdP will support and for which you have provided the needed files. (Point ```8.``` and ```9.```)

10. Run this command to run Ansible on develoment inventory to install and configure an IdP (under development) only on a specific development server:
    ```ansible-playbook site.yml -i development.ini --limit FQDN --vault-password-file .vault_pass.txt```

11. Run this command to run Ansible on develoment inventory to install and configure an IdP (under development) into all development servers:
    ```ansible-playbook site.yml -i development.ini --vault-password-file .vault_pass.txt```

## Documentation ##
The environment (production,development, test, ...) are located into different files:
   - ```development.ini```
   - ```production.ini```
   - ```test.ini```
   - ...

Each environment file divides the architectures through different labels:
   - ```[Debian]```
   - ```[RedHat]```
   - ...

The "```site.yml```" file contains what will be installed on the machine provided by the environment:
   - ```shib-idp.yml``` (Install,Configure and Run a Shibboleth IdP)
   - ...

The "```shib-idp.yml```" contains:
   - ```hosts``` (who will receive the sync)
   - ```remote_user``` (who will access via SSH on the servers)
   - ```roles``` (what will be installed and configured on the servers)

The "```group_vars/```" directory contains:
   - ```all.yml```      (will contains all shared variable between architectures)
   - ```Debian.yml```   (will contains all variable debian-oriented)
   - ```RedHat.yml```   (will contains all variable redhat-oriented)

"```host_vars```" directory contains one ```FQDN.yml``` file for each server that contains specific variables for the host. 
(This files have to be encrypted if shared on GitHub or somewhere other)

## Useful Commands ##

```
--- development.ini ---
[Debian]
ansible-slave-1.example.garr.it
ansible-slave-2.test.garr.it
-----------------------
```

1. Test that the connection with the server(s) is working:
   * ```ansible all -m ping -i /opt/ansible-shibboleth/development.ini -u debian```
   ("```debian```" is the user used to perform the SSH connection with the client to synchronize)

2. Get the facts from the server(s):
   * ```ansible GROUP_NAME_or_HOST_NAME -m setup -i /opt/ansible-shibboleth/development.ini -u debian```

   Examples:
      * without encrypted files:
         ```ansible GROUP_NAME_or_HOST_NAME -m setup -i /opt/ansible-shibboleth/development.ini -u debian```
      * with encrypted files:
         ```ansible GROUP_NAME_or_HOST_NAME -m setup -i /opt/ansible-shibboleth/development.ini -u debian --vault-password-file .vault_pass.txt```

   ("```.vault_pass.txt```" is the file you have created that contains the encryption password)

3. Encrypt files:
   * ```ansible-vault encrypt host_vars/#_full.qualified.domain.name_#.yml --vault-password-file .vault_pass.txt```

4. Decrypt Encrypted files:
   * ```ansible-vault decrypt host_vars/#_full.qualified.domain.name_#.yml --vault-password-file .vault_pass.txt```

5. View Encrypted files:
   * ```ansible-vault view host_vars/#_full.qualified.domain.name_#.yml --vault-password-file .vault_pass.txt```
