##
## Velocity Template for DisplayUsernamePasswordPage view-state
##
## Velocity context will contain the following properties
## flowExecutionUrl - the form action location
## flowRequestContext - the Spring Web Flow RequestContext
## flowExecutionKey - the SWF execution key (this is built into the flowExecutionUrl)
## profileRequestContext - root of context tree
## authenticationContext - context with authentication request information
## authenticationErrorContext - context with login error state
## authenticationWarningContext - context with login warning state
## ldapResponseContext - context with LDAP state (if using native LDAP)
## rpUIContext - the context with SP UI information from the metadata
## extendedAuthenticationFlows - collection of "extended" AuthenticationFlowDescriptor objects
## passwordPrincipals - contents of the shibboleth.authn.Password.PrincipalOverride bean
## encoder - HTMLEncoder class
## request - HttpServletRequest
## response - HttpServletResponse
## environment - Spring Environment object for property resolution
## custom - arbitrary object injected by deployer
##
#set ($rpContext = $profileRequestContext.getSubcontext('net.shibboleth.idp.profile.context.RelyingPartyContext'))
#set ($username = $authenticationContext.getSubcontext('net.shibboleth.idp.authn.context.UsernamePasswordContext', true).getUsername())
#set ($passwordEnabled = false)
#if (!$passwordPrincipals or $passwordPrincipals.isEmpty() or $authenticationContext.isAcceptable($passwordPrincipals))
  #set ($passwordEnabled = true)
#end
##
<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width,initial-scale=1.0">
        <title>#springMessageText("idp.title", "Web Login Service")</title>
        <link rel="stylesheet" type="text/css" href="$request.getContextPath()/css/main.css">
        <link href="#springMessageText("metadata.favicon", "#")" rel="shortcut icon" type="image/x-icon" />
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap.min.css">
        <link rel="stylesheet" type="text/css" href="$request.getContextPath()/css/main.css">
        <link rel="stylesheet" type="text/css" href="/css/login.css">
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
        <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/js/bootstrap.min.js"></script>
            <script language="javascript">
            function setParam(name, value) {
                var l = window.location;
                /* build params */
                var params = {};
                var x = /(?:\??)([^=&?]+)=?([^&?]*)/g;
                var s = l.search;
                for(var r = x.exec(s); r; r = x.exec(s)) {
                    r[1] = decodeURIComponent(r[1]);
                    if (!r[2]) r[2] = '%%';
                    params[r[1]] = r[2];
                }
                /* set param */
                params[name] = encodeURIComponent(value);
                /* build search */
                var search = [];
                for(var i in params) {
                    var p = encodeURIComponent(i);
                    var v = params[i];
                    if (v != '%%') p += '=' + v;
                    search.push(p);
                }
                search = search.join('&');
                /* execute search */
                l.search = search;
            }
            function getParameterByName(name) {
                name = name.replace(/[\[]/, "\\\[").replace(/[\]]/, "\\\]");
                var regex = new RegExp("[\\?&]" + name + "=([^&#]*)");
                var results = regex.exec(location.search);
                return results == null ? "" : decodeURIComponent(results[1].replace(/\+/g, " "));
            }
            function check_epb() {
                var cookiestring = RegExp("epb[^;]+").exec(document.cookie);
                var value = unescape(!!cookiestring ? cookiestring.toString().replace(/^[^=]+./,"") : "");
                if (value == "ok") {
                    document.getElementById('epb-notice').style.display = 'none';
                }
            }
            function hide_epb() {
                document.cookie = "epb=ok; expires=Fri, 31 Dec 9999 23:59:59 GMT";
                document.getElementById('epb-notice').style.display = 'none';
            }
            function show_policy() {
                el = document.getElementById("overlay");
                el.style.display = (el.style.display == "none") ? "block" : "none";
            }
        </script>
    </head>
    <body onload="check_epb()">

        <div id="overlay" style="display: none">
            <div>
                <h1>#springMessage("idp.login.epb.title")</h1>
                <h2>#springMessage("idp.login.epb.subtitle1")</h2>
                <p>#springMessage("idp.login.epb.paragraph1_1")</p>
                <p>#springMessage("idp.login.epb.paragraph1_2")</p>
                <h2>#springMessage("idp.login.epb.subtitle2")</h2>
                <p>#springMessage("idp.login.epb.paragraph2_1")</p>
                <h2>#springMessage("idp.login.epb.subtitle3")</h2>
                <p>#springMessage("idp.login.epb.paragraph3_1")</p>
                <h2>#springMessage("idp.login.epb.subtitle4")</h2>
                <p>#springMessage("idp.login.epb.paragraph4_1")</p>
                <p>#springMessage("idp.login.epb.paragraph4_2")</p>
                <p><br/></p>
                <p>#springMessage("idp.login.epb.paragraph4_3")</p>
                <h2>#springMessage("idp.login.epb.subtitle5")</h2>
                <p>#springMessage("idp.login.epb.paragraph5_1")</p>
                <p>#springMessage("idp.login.epb.paragraph5_2")</p>
                <h2>#springMessage("idp.login.epb.subtitle6")</h2>
                <p>#springMessage("idp.login.epb.paragraph6_1")</p>
                <p>#springMessage("idp.login.epb.paragraph6_2")</p>
                <p><br/></p>
                <p><center><a href='#' onclick='show_policy(); return false'>#springMessage("idp.login.epb.close")</a></center></p>
            </div>
        </div>

        <div class="wrapper">
            <div id="epb-notice">#springMessage("idp.login.epb") <a href="#" onclick="show_policy(); return false">#springMessage("idp.login.epb_info")</a> <a href="#" onclick="hide_epb(); return false">#springMessage("idp.login.epb_ok")</a></div>

            <div class="container">
                <header>
                    #if ($request.getParameter("spinfo") == "true")
                    <br/>
                        #set ($logo = $rpUIContext.getLogo())
                        #if ($logo)
                    <img src= "$encoder.encodeForHTMLAttribute($logo)" alt="Logo">
                        #end
                    <br/><b>#springMessageText("sp.description", "SP description")</b><br/>
                        #set ($desc = $rpUIContext.getServiceDescription())
                        #if ($desc)
                    $encoder.encodeForHTML($desc)
                        #end
                    <br/><br/>
                    <a href="javascript:setParam('spinfo', 'false');"><span class="item-marker">&lsaquo;</span> #springMessageText("idp.login.goback", "Go back to login page")</a>
                    #else
                    <a href="#springMessageText("idp.infoUrl", "#")"><img src="#springMessage("idp.logo")" alt="#springMessageText("idp.logo.alt-text", "logo")" height="170px"></a>
                    #end
                </header>

                <div class="content">
                    #if ($request.getParameter("spinfo") == "true")
                    <ul>
                        <li><span class="item-marker">&rsaquo;</span> <b>#springMessageText("sp.description", "SP Description"):</b><br/>$rpUIContext.serviceDescription</li>
                        <li><span class="item-marker">&rsaquo;</span> <b>#springMessageText("sp.organization", "SP Organization"):</b><br/>
                        #if($rpUIContext.organizationDisplayName)
                        $rpUIContext.organizationDisplayName
                        #else
                        $rpUIContext.organizationName
                        #end
                        </li>
                        <li><span class="item-marker">&rsaquo;</span> <b>#springMessageText("sp.contacts", "SP Contacts"):</b><br/>
                        #set ($technicalEmail = $rpUIContext.getContactEmail("technical"))
                        #set ($technicalName = $rpUIContext.getContactGivenName("technical"))
                        #set ($technicalSurName = $rpUIContext.getContactSurName("technical"))
                        #if ($technicalEmail)
                            <a href='$encoder.encodeForHTMLAttribute($technicalEmail)'>
                            #if ($technicalName && $technicalSurName)
                                $encoder.encodeForHTMLAttribute($technicalName) $encoder.encodeForHTMLAttribute($technicalSurName)
                            #else
                                $encoder.encodeForHTMLAttribute($technicalEmail.replace("mailto:", ""))
                            #end
                            </a>
                        #else
                            #springMessageText("sp.nocontacts", "No contacts provided")
                        #end
                        </li>
                        <li><span class="item-marker">&rsaquo;</span>
                        #set ($psurl = $rpUIContext.privacyStatementURL)
                        #if ($psurl)
                            <b><a href="$encoder.encodeForHTMLAttribute($psurl)">#springMessageText("sp.privacypage", "Privacy Policy page")</a></b>
                        #else
                            <b>#springMessageText("sp.noprivacy", "No privacy policy specified")</b>
                        #end
                        </li>
                        <li><span class="item-marker">&rsaquo;</span>
                        #set ($infoURL=$rpUIContext.informationURL)
                        #if ($infoURL)
                            <b><a href="$encoder.encodeForHTMLAttribute($infoURL)">#springMessageText("sp.infopage", "Information page")</a></b>
                        #else
                            <b>#springMessageText("sp.noinfopage", "No information website provided")</b>
                        #end
                        </li>
                    </ul>
                    #else
                    <div class="column one">
                            #parse("login-error.vm")

                        <form action="$flowExecutionUrl" method="post">

                            #set ($serviceName = $rpUIContext.serviceName)
                            #if ($serviceName && !$rpContext.getRelyingPartyId().contains($serviceName))
                            <legend>
                                #springMessageText("idp.login.loginTo", "Login to") $encoder.encodeForHTML($serviceName)
                            </legend>
                            #end

                            #if ($passwordEnabled)
                            <div class="form-element-wrapper">
                                <label for="username">#springMessageText("idp.login.username", "Username")</label>
                                <input class="form-element form-field" id="username" name="j_username" type="text" value="#if($username)$encoder.encodeForHTML($username)#end">
                            </div>

                            <div class="form-element-wrapper">
                                <label for="password">#springMessageText("idp.login.password", "Password")</label>
                                <input class="form-element form-field" id="password" name="j_password" type="password" value="">
                            </div>

                            <div class="form-element-wrapper">
                                <input type="checkbox" name="donotcache" value="1" id="donotcache">
                                <label for="donotcache">#springMessageText("idp.login.donotcache", "Don't Remember Login")</label>
                            </div>
                            #end

                            <div class="form-element-wrapper">
                                <input id="_shib_idp_revokeConsent" type="checkbox" name="_shib_idp_revokeConsent" value="true">
                                <label for="_shib_idp_revokeConsent">#springMessageText("idp.attribute-release.revoke", "Clear prior granting of permission for release of your information to this service.")</label>
                            </div>

                            #if ($passwordEnabled)
                            <div class="form-element-wrapper">
                                <button class="form-element form-button" type="submit" name="_eventId_proceed"
                                        onClick="this.childNodes[0].nodeValue='#springMessageText("idp.login.pleasewait", "Logging in, please wait...")'"
                                        >#springMessageText("idp.login.login", "Login")</button>
                            </div>
                            #end

                            #foreach ($extFlow in $extendedAuthenticationFlows)
                                #if ($authenticationContext.isAcceptable($extFlow) and $extFlow.apply(profileRequestContext))
                            <div class="form-element-wrapper">
                              <button class="form-element form-button" type="submit" name="_eventId_$extFlow.getId()">
                                    #springMessageText("idp.login.$extFlow.getId().replace('authn/','')", $extFlow.getId().replace('authn/',''))
                              </button>
                            </div>
                                #end
                            #end
                        </form>

                        #*
                          //
                          //    SP Description & Logo (optional)
                          //    These idpui lines will display added information (if available
                          //    in the metadata) about the Service Provider (SP) that requested
                          //    authentication. These idpui lines are "active" in this example
                          //    (not commented out) - this extra SP info will be displayed.
                          //    Remove or comment out these lines to stop the display of the
                          //    added SP information.
                          //
                        *#
                            #set ($logo = $rpUIContext.getLogo())
                            #if ($logo)
                        <img src= "$encoder.encodeForHTMLAttribute($logo)" alt="$encoder.encodeForHTMLAttribute($serviceName)" height="128px"><br/>
                            #end
                            #set ($desc = $rpUIContext.getServiceDescription())
                            #if ($desc)
                            $encoder.encodeForHTML($desc)
                            #end

                        <p><a href="javascript:setParam('spinfo', 'true');"><span class="item-marker">&rsaquo;</span> #springMessageText("idp.login.moreinfo", "More information about the service")</a></p>

                    </div> ## column one
                    <div class="column two">
                        <ul class="list list-help">
                            #if ($passwordEnabled)
                            <li class="list-help-item"><a href="#springMessageText("idp.url.password.reset", "#")"><span class="item-marker">&rsaquo;</span> #springMessageText("idp.login.forgotPassword", "Forgot password?")</a></li>
                            #end
                            <li class="list-help-item"><a href="#springMessageText("idp.url.helpdesk", "#")"><span class="item-marker">&rsaquo;</span> #springMessageText("idp.login.needHelp", "Need Help?")</a></li>
                            <li class="list-help-item"><a href="#springMessageText("idp.infoUrl", "#")"><span class="item-marker">&rsaquo;</span> #springMessageText("idp.infopage", "Information page")</a></li>
                            <li class="list-help-item"><a href="#springMessageText("idp.privacyPage", "#")"><span class="item-marker">&rsaquo;</span> #springMessageText("idp.privacypage", "Privacy Policy")</a></li>
                        </ul>
                        <p>
                            <a href="javascript:setParam('lang', 'it');"><img height="16px" src="/images/itFlag.png"></a>
                            <a href="javascript:setParam('lang', 'en');"><img height="16px" src="/images/enFlag.png"></a>
                        </p>
                        <p>
                            <a href="http://www.idem.garr.it"><img src="/images/federation-logo.png" alt="federation-name" style="width: 100px"/></a>
                        </p>
                    </div> ## column two
                        #end
                </div> ## content
            </div> ## container

            <footer>
                <div class="container container-footer">
                    <p class="footer-text">#springMessageText("idp.footer", "Insert your footer text here.")</p>
                </div>
            </footer>
        </div> ## wrapper
    </body>
</html>
